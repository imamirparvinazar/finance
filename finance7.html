<!doctype html>
<html lang="fa" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>مدیریت مالی هوشمند</title>

        <!-- React & ReactDOM -->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.development.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Google Fonts: Zain -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Zain:wght@200;300;400;700;800;900&display=swap"
            rel="stylesheet"
        />

        <!-- Material Symbols -->
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
        />

        <!-- Markdown Parser -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ["Zain", "sans-serif"],
                        },
                        colors: {
                            primary: "var(--color-primary)",
                            onPrimary: "var(--color-on-primary)",
                            primaryContainer: "var(--color-primary-container)",
                            onPrimaryContainer:
                                "var(--color-on-primary-container)",
                            secondary: "var(--color-secondary)",
                            surface: "var(--color-surface)",
                            surfaceVariant: "var(--color-surface-variant)",
                            outline: "var(--color-outline)",
                            income: "var(--color-income)",
                            expense: "var(--color-expense)",
                            ai: "var(--color-ai)",
                            aiSurface: "var(--color-ai-surface)",
                            error: "#BA1A1A", // Define error color for alerts
                            onError: "#FFFFFF",
                        },
                        animation: {
                            "slide-up":
                                "slide-up 0.4s cubic-bezier(0.2, 0.0, 0, 1.0) forwards",
                            "fade-in":
                                "fade-in 0.3s cubic-bezier(0.2, 0.0, 0, 1.0) forwards",
                            "scale-in":
                                "scale-in 0.3s cubic-bezier(0.2, 0.0, 0, 1.0) forwards",
                            "pulse-glow": "pulse-glow 2s infinite",
                        },
                        keyframes: {
                            "slide-up": {
                                "0%": {
                                    transform: "translateY(100%)",
                                    opacity: "0",
                                },
                                "100%": {
                                    transform: "translateY(0)",
                                    opacity: "1",
                                },
                            },
                            "fade-in": {
                                "0%": { opacity: "0" },
                                "100%": { opacity: "1" },
                            },
                            "scale-in": {
                                "0%": { transform: "scale(0.9)", opacity: "0" },
                                "100%": { transform: "scale(1)", opacity: "1" },
                            },
                            "pulse-glow": {
                                "0%": {
                                    boxShadow:
                                        "0 0 0 0 rgba(26, 115, 232, 0.4)",
                                },
                                "70%": {
                                    boxShadow:
                                        "0 0 0 15px rgba(26, 115, 232, 0)",
                                },
                                "100%": {
                                    boxShadow: "0 0 0 0 rgba(26, 115, 232, 0)",
                                },
                            },
                        },
                    },
                },
            };
        </script>
        <style>
            :root {
                --color-primary: #6750a4;
                --color-on-primary: #ffffff;
                --color-primary-container: #eaddff;
                --color-on-primary-container: #21005d;
                --color-secondary: #625b71;
                --color-surface: #fef7ff;
                --color-surface-variant: #e7e0ec;
                --color-outline: #79747e;
                --color-income: #006d3b;
                --color-expense: #ba1a1a;
                --color-ai: #1a73e8;
                --color-ai-surface: #f0f7ff;
                --bg-body: #fdfbff;
                --text-main: #1f2937;
            }

            .dark {
                --color-primary: #d0bcff;
                --color-on-primary: #381e72;
                --color-primary-container: #4f378b;
                --color-on-primary-container: #eaddff;
                --color-secondary: #ccc2dc;
                --color-surface: #141218;
                --color-surface-variant: #49454f;
                --color-outline: #938f99;
                --color-income: #4ade80;
                --color-expense: #f87171;
                --color-ai: #60a5fa;
                --color-ai-surface: #1e293b;
                --bg-body: #0f0f0f;
                --text-main: #e2e8f0;
            }

            body {
                font-family: "Zain", sans-serif;
                background-color: var(--bg-body);
                color: var(--text-main);
                overflow-x: hidden;
                transition:
                    background-color 0.3s,
                    color 0.3s;
            }
            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background-color: var(--color-outline);
                border-radius: 4px;
            }

            .card-shadow {
                box-shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.1),
                    0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }
            .dark .glass-effect {
                background: rgba(20, 18, 24, 0.85);
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .markdown-body ul {
                list-style-type: disc;
                padding-right: 20px;
                margin-bottom: 10px;
            }
            .markdown-body p {
                margin-bottom: 8px;
            }
            .markdown-body strong {
                color: var(--color-primary);
                font-weight: 800;
            }
            .dark .markdown-body {
                color: #e2e8f0;
            }

            input,
            textarea,
            select {
                color: var(--text-main);
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect, useMemo, useRef } = React;

            // --- Data ---
            const categories = {
                expense: [
                    { id: "food", name: "خوراک", icon: "restaurant" },
                    {
                        id: "transport",
                        name: "حمل و نقل",
                        icon: "directions_car",
                    },
                    { id: "home", name: "مسکن", icon: "home" },
                    { id: "health", name: "درمان", icon: "medical_services" },
                    { id: "shopping", name: "خرید", icon: "shopping_bag" },
                    { id: "bills", name: "قبوض", icon: "receipt_long" },
                    { id: "education", name: "آموزش", icon: "school" },
                    { id: "entertainment", name: "تفریح", icon: "movie" },
                    { id: "other", name: "سایر", icon: "more_horiz" },
                ],
                income: [
                    { id: "salary", name: "حقوق", icon: "payments" },
                    { id: "freelance", name: "پروژه", icon: "computer" },
                    { id: "investment", name: "سرمایه", icon: "trending_up" },
                    { id: "gift", name: "هدیه", icon: "card_giftcard" },
                    { id: "selling", name: "فروش", icon: "storefront" },
                    { id: "other", name: "سایر", icon: "attach_money" },
                ],
            };

            const FREE_MODELS = [
                "deepseek/deepseek-chat-v3-0324",
                "x-ai/grok-4.1-fast",
                "kwaipilot/kat-coder-pro",
            ];

            const Icon = ({ name, className = "" }) => (
                <span
                    className={`material-symbols-rounded select-none ${className}`}
                >
                    {name}
                </span>
            );

            const formatMoney = (amount) =>
                new Intl.NumberFormat("fa-IR").format(amount);

            // Helper to get today's date in Shamsi
            const getTodayShamsi = () => {
                return new Intl.DateTimeFormat("fa-IR-u-ca-persian", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                }).format(new Date());
            };

            // --- OpenRouter API with Fallback ---
            const callOpenRouter = async (
                prompt,
                userApiKey,
                isJson = false,
            ) => {
                if (!userApiKey)
                    throw new Error("لطفا کلید API را در تنظیمات وارد کنید.");

                let lastError = null;

                // Try models in sequence
                for (const model of FREE_MODELS) {
                    try {
                        console.log(`Trying model: ${model}`);
                        const response = await fetch(
                            "https://openrouter.ai/api/v1/chat/completions",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${userApiKey}`,
                                    "HTTP-Referer": window.location.href,
                                    "X-Title": "Persian Money Manager",
                                },
                                body: JSON.stringify({
                                    model: model,
                                    messages: [
                                        {
                                            role: "user",
                                            content:
                                                prompt +
                                                (isJson
                                                    ? "\nReturn raw JSON only, no markdown formatting."
                                                    : ""),
                                        },
                                    ],
                                    response_format: isJson
                                        ? { type: "json_object" }
                                        : undefined,
                                }),
                            },
                        );

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(
                                errData.error?.message || "API Error",
                            );
                        }

                        const data = await response.json();
                        let text = data.choices[0].message.content;

                        if (isJson) {
                            text = text
                                .replace(/```json/g, "")
                                .replace(/```/g, "")
                                .trim();
                            // Verify if it parses correctly
                            JSON.parse(text);
                        }
                        return isJson ? JSON.parse(text) : text;
                    } catch (error) {
                        console.warn(`Model ${model} failed:`, error);
                        lastError = error;
                        // Continue to next model
                    }
                }

                throw new Error(
                    `All models failed. Last error: ${lastError?.message}`,
                );
            };

            // --- Custom Modal Component ---
            const CustomModal = ({
                isOpen,
                title,
                message,
                type,
                onConfirm,
                onClose,
            }) => {
                if (!isOpen) return null;

                const isAlert = type === "alert";
                const isConfirm = type === "confirm";

                // Define colors and icon based on message content/type
                let iconName = "info";
                let iconColor = "text-primary";

                if (isConfirm) {
                    iconName = "help_outline";
                    iconColor = "text-error";
                } else if (message.includes("موفقیت")) {
                    iconName = "check_circle";
                    iconColor = "text-income";
                } else if (
                    message.includes("خطا") ||
                    message.includes("لازم است")
                ) {
                    iconName = "warning";
                    iconColor = "text-error";
                }

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                        <div
                            className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-fade-in"
                            onClick={onClose}
                        ></div>
                        <div className="bg-surface p-8 rounded-[28px] w-full max-w-xs shadow-2xl relative animate-scale-in z-10 text-center">
                            <div
                                className={`w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center ${iconColor} bg-surfaceVariant`}
                            >
                                <Icon name={iconName} className="text-3xl" />
                            </div>

                            <h3 className="text-xl font-bold mb-3 text-onPrimaryContainer">
                                {title}
                            </h3>
                            <p className="text-secondary mb-6 text-sm leading-6">
                                {message}
                            </p>

                            <div
                                className={`flex ${isAlert ? "justify-center" : "justify-between gap-3"}`}
                            >
                                {isConfirm && (
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 bg-surfaceVariant text-outline rounded-xl font-bold hover:bg-surfaceVariant/80 transition-colors"
                                    >
                                        انصراف
                                    </button>
                                )}
                                <button
                                    onClick={onConfirm}
                                    className={`py-3 rounded-xl font-bold transition-all ${isAlert ? "w-full bg-primary text-onPrimary shadow-lg shadow-primary/30" : "flex-1 bg-error text-onError shadow-lg shadow-error/30"}`}
                                >
                                    {isConfirm ? "تایید حذف" : "متوجه شدم"}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- App ---
            function App() {
                // Data
                const [transactions, setTransactions] = useState([]);

                // Settings & Auth
                const [openRouterKey, setOpenRouterKey] = useState("");
                const [isSettingsOpen, setIsSettingsOpen] = useState(false);
                const [isDarkMode, setIsDarkMode] = useState(false);

                // UI State
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [viewStep, setViewStep] = useState("input");
                const [selectedCategoryId, setSelectedCategoryId] =
                    useState(null); // For category detail view

                // Draft State
                const [draftTx, setDraftTx] = useState({
                    type: "expense",
                    amount: "",
                    category: "",
                    date: "",
                    desc: "",
                });

                // AI Processing
                const [aiInput, setAiInput] = useState("");
                const [isProcessing, setIsProcessing] = useState(false);
                const [aiAnalysis, setAiAnalysis] = useState(null);
                const [isAnalyzing, setIsAnalyzing] = useState(false);

                // Custom Modal State
                const [customModal, setCustomModal] = useState({
                    isOpen: false,
                    title: "",
                    message: "",
                    type: "alert", // 'alert' or 'confirm'
                    onConfirm: () => {},
                    onClose: () => {},
                });

                // File Input Ref
                const fileInputRef = useRef(null);

                // --- Custom Modal Helpers ---
                const closeCustomModal = () => {
                    setCustomModal({
                        isOpen: false,
                        title: "",
                        message: "",
                        type: "alert",
                        onConfirm: () => {},
                        onClose: () => {},
                    });
                };

                const showAlert = (message, title = "توجه") => {
                    setCustomModal({
                        isOpen: true,
                        title: title,
                        message: message,
                        type: "alert",
                        onConfirm: closeCustomModal,
                        onClose: closeCustomModal,
                    });
                };

                const showConfirm = (
                    message,
                    title = "تایید عملیات",
                    onConfirm,
                    onCancel = closeCustomModal,
                ) => {
                    setCustomModal({
                        isOpen: true,
                        title: title,
                        message: message,
                        type: "confirm",
                        onConfirm: () => {
                            onConfirm();
                            closeCustomModal();
                        },
                        onClose: onCancel,
                    });
                };
                // --- End Custom Modal Helpers ---

                // Load Data & Theme
                useEffect(() => {
                    const saved = localStorage.getItem("finance_data");
                    if (saved) setTransactions(JSON.parse(saved));

                    const savedKey = localStorage.getItem("openrouter_key");
                    if (savedKey) setOpenRouterKey(savedKey);

                    const savedTheme = localStorage.getItem("theme");
                    if (
                        savedTheme === "dark" ||
                        (!savedTheme &&
                            window.matchMedia("(prefers-color-scheme: dark)")
                                .matches)
                    ) {
                        setIsDarkMode(true);
                        document.documentElement.classList.add("dark");
                    } else {
                        setIsDarkMode(false);
                        document.documentElement.classList.remove("dark");
                    }
                }, []);

                // Save Data
                useEffect(() => {
                    localStorage.setItem(
                        "finance_data",
                        JSON.stringify(transactions),
                    );
                }, [transactions]);

                const toggleTheme = () => {
                    const newMode = !isDarkMode;
                    setIsDarkMode(newMode);
                    if (newMode) {
                        document.documentElement.classList.add("dark");
                        localStorage.setItem("theme", "dark");
                    } else {
                        document.documentElement.classList.remove("dark");
                        localStorage.setItem("theme", "light");
                    }
                };

                const saveKey = (key) => {
                    setOpenRouterKey(key);
                    localStorage.setItem("openrouter_key", key);
                };

                // --- Import / Export Logic ---
                const handleExportData = () => {
                    const dataStr = JSON.stringify(transactions, null, 2);
                    const blob = new Blob([dataStr], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `finance_backup_${getTodayShamsi().replace(/\//g, "-")}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                const handleImportData = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (Array.isArray(imported)) {
                                showConfirm(
                                    "آیا مطمئن هستید؟ داده‌های فعلی شما با داده‌های فایل جایگزین خواهند شد.",
                                    "هشدار جایگزینی داده",
                                    () => {
                                        setTransactions(imported);
                                        showAlert(
                                            "داده‌ها با موفقیت بازیابی شدند.",
                                            "موفقیت",
                                        );
                                        setIsSettingsOpen(false); // Close modal on success
                                    },
                                );
                            } else {
                                showAlert(
                                    "فرمت فایل JSON صحیح نیست. باید آرایه‌ای از تراکنش‌ها باشد.",
                                    "خطای فایل",
                                );
                            }
                        } catch (err) {
                            showAlert("خطا در خواندن فایل JSON.", "خطای فایل");
                            console.error(err);
                        }
                    };
                    reader.readAsText(file);
                    // Reset value so same file can be selected again
                    event.target.value = "";
                };

                const stats = useMemo(() => {
                    const totalIncome = transactions
                        .filter((t) => t.type === "income")
                        .reduce((acc, curr) => acc + Number(curr.amount), 0);
                    const totalExpense = transactions
                        .filter((t) => t.type === "expense")
                        .reduce((acc, curr) => acc + Number(curr.amount), 0);
                    return {
                        totalIncome,
                        totalExpense,
                        balance: totalIncome - totalExpense,
                    };
                }, [transactions]);

                // --- AI Handlers ---

                const handleProcessAI = async () => {
                    if (!aiInput.trim()) return;
                    if (!openRouterKey) {
                        setIsSettingsOpen(true);
                        return showAlert(
                            "لطفا برای استفاده از تحلیل هوشمند، کلید OpenRouter خود را در بخش تنظیمات وارد کنید.",
                            "کلید API لازم است",
                        );
                    }
                    setIsProcessing(true);

                    const today = getTodayShamsi();
                    const prompt = `
                    You are a Persian finance assistant.
                    Current Date (Shamsi): ${today}.

                    Extract transaction details from this Persian text: "${aiInput}".

                    Rules:
                    1. Categories IDs: [food, transport, home, health, shopping, bills, education, entertainment, other, salary, freelance, investment, gift, selling].
                    2. If user says "today" or "emrooz", use ${today}.
                    3. If no date is mentioned, use ${today}.
                    4. Return ONLY raw JSON object.

                    JSON Schema:
                    {
                        "amount": number,
                        "category": string (id),
                        "type": "expense" or "income",
                        "desc": string,
                        "date": string (yyyy/mm/dd shamsi)
                    }
                `;

                    try {
                        const data = await callOpenRouter(
                            prompt,
                            openRouterKey,
                            true,
                        );
                        setDraftTx({
                            type: data.type || "expense",
                            amount: data.amount || "",
                            category: data.category || "other",
                            desc: data.desc || aiInput,
                            date: data.date || today,
                            id: Date.now(),
                        });
                        setViewStep("review");
                    } catch (err) {
                        showAlert(
                            "خطا در تحلیل هوشمند: " + err.message,
                            "خطای هوش مصنوعی",
                        );
                    } finally {
                        setIsProcessing(false);
                    }
                };

                const handleSaveDraft = () => {
                    setTransactions([
                        { ...draftTx, id: Date.now() },
                        ...transactions,
                    ]);
                    setIsModalOpen(false);
                    setAiInput("");
                    setViewStep("input");
                    showAlert("تراکنش با موفقیت ثبت شد.", "ثبت موفق");
                };

                const handleDelete = (id) => {
                    showConfirm(
                        "آیا از حذف این تراکنش مطمئن هستید؟",
                        "حذف تراکنش",
                        () =>
                            setTransactions(
                                transactions.filter((t) => t.id !== id),
                            ),
                    );
                };

                const handleAdvisor = async () => {
                    if (transactions.length === 0) return;
                    if (!openRouterKey) {
                        setIsSettingsOpen(true);
                        return showAlert(
                            "لطفا برای استفاده از تحلیل هوشمند، کلید OpenRouter خود را در بخش تنظیمات وارد کنید.",
                            "کلید API لازم است",
                        );
                    }
                    setIsAnalyzing(true);
                    setAiAnalysis(null);

                    const today = getTodayShamsi();
                    const simpleData = transactions
                        .slice(0, 30)
                        .map(
                            (t) =>
                                `${t.date}: ${t.type} ${t.amount} (${t.category})`,
                        );

                    const prompt = `
                    Role: Expert Persian Financial Advisor.
                    Today's Date: ${today}.
                    Data: ${JSON.stringify(simpleData)}.

                    Task:
                    1. Analyze spending habits.
                    2. Give a brief financial health summary.
                    3. Suggest ONE actionable tip.

                    Output: Persian language, Markdown format. Keep it concise.
                `;

                    try {
                        const result = await callOpenRouter(
                            prompt,
                            openRouterKey,
                            false,
                        );
                        setAiAnalysis(result);
                    } catch (e) {
                        showAlert("خطا: " + e.message, "خطای هوش مصنوعی");
                    } finally {
                        setIsAnalyzing(false);
                    }
                };

                const activeCategories =
                    draftTx.type === "expense"
                        ? categories.expense
                        : categories.income;

                // --- Category Detail View Helper ---
                const getCategoryDetails = () => {
                    if (!selectedCategoryId) return null;
                    const cat = [
                        ...categories.expense,
                        ...categories.income,
                    ].find((c) => c.id === selectedCategoryId);
                    const txs = transactions.filter(
                        (t) => t.category === selectedCategoryId,
                    );
                    const total = txs.reduce(
                        (acc, curr) => acc + Number(curr.amount),
                        0,
                    );
                    return { cat, txs, total };
                };

                const catDetails = getCategoryDetails();

                return (
                    <div className="min-h-screen pb-24 md:pb-10 font-sans selection:bg-primaryContainer selection:text-onPrimaryContainer transition-colors">
                        {/* Hidden Input for Import */}
                        <input
                            type="file"
                            accept=".json"
                            ref={fileInputRef}
                            style={{ display: "none" }}
                            onChange={handleImportData}
                        />

                        {/* Header */}
                        <header className="fixed top-0 inset-x-0 z-30 glass-effect">
                            <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                                <div className="flex items-center gap-3 animate-fade-in">
                                    <div className="w-10 h-10 rounded-2xl bg-gradient-to-tr from-primary to-purple-600 flex items-center justify-center text-white shadow-lg shadow-primary/30">
                                        <Icon name="auto_awesome" />
                                    </div>
                                    <h1 className="text-xl font-bold tracking-tight">
                                        کیف پول هوشمند
                                    </h1>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={toggleTheme}
                                        className="p-2 rounded-full hover:bg-surfaceVariant transition-colors text-secondary"
                                    >
                                        <Icon
                                            name={
                                                isDarkMode
                                                    ? "light_mode"
                                                    : "dark_mode"
                                            }
                                        />
                                    </button>
                                    <button
                                        onClick={() => setIsSettingsOpen(true)}
                                        className="p-2 rounded-full hover:bg-surfaceVariant transition-colors text-secondary"
                                    >
                                        <Icon name="settings" />
                                    </button>
                                </div>
                            </div>
                        </header>

                        {/* Category Detail Full Page Modal (MUI Style Slide Up) */}
                        {selectedCategoryId && catDetails && (
                            <div className="fixed inset-0 z-40 bg-surface animate-slide-up flex flex-col">
                                {/* Toolbar */}
                                <div className="p-4 flex items-center gap-4 border-b border-surfaceVariant sticky top-0 bg-surface z-10">
                                    <button
                                        onClick={() =>
                                            setSelectedCategoryId(null)
                                        }
                                        className="p-2 hover:bg-surfaceVariant rounded-full transition-colors"
                                    >
                                        <Icon
                                            name="arrow_forward"
                                            className="text-2xl text-onPrimaryContainer"
                                        />
                                    </button>
                                    <div className="flex items-center gap-2">
                                        <Icon
                                            name={catDetails.cat?.icon}
                                            className="text-primary text-2xl"
                                        />
                                        <h2 className="text-xl font-bold text-onPrimaryContainer">
                                            {catDetails.cat?.name}
                                        </h2>
                                    </div>
                                </div>

                                {/* Content */}
                                <div className="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full">
                                    <div className="bg-primaryContainer rounded-[24px] p-8 text-center mb-6 animate-scale-in">
                                        <p className="text-onPrimaryContainer opacity-70 mb-2">
                                            مجموع تراکنش‌ها
                                        </p>
                                        <h3 className="text-4xl font-black text-onPrimaryContainer dir-ltr">
                                            {formatMoney(catDetails.total)}
                                        </h3>
                                        <p className="text-xs opacity-60 mt-2 font-bold">
                                            تومان
                                        </p>
                                    </div>

                                    <div className="space-y-3">
                                        {catDetails.txs.length === 0 ? (
                                            <p className="text-center text-outline mt-10">
                                                تراکنشی در این دسته وجود ندارد.
                                            </p>
                                        ) : (
                                            catDetails.txs.map((tx, idx) => (
                                                <div
                                                    key={tx.id}
                                                    style={{
                                                        animationDelay: `${idx * 50}ms`,
                                                    }}
                                                    className="bg-surfaceVariant/30 p-4 rounded-[20px] flex justify-between items-center animate-slide-up border border-transparent hover:border-outline/20"
                                                >
                                                    <div>
                                                        <p className="font-bold text-onPrimaryContainer">
                                                            {tx.desc}
                                                        </p>
                                                        <p className="text-xs text-outline mt-1">
                                                            {tx.date}
                                                        </p>
                                                    </div>
                                                    <span
                                                        className={`font-bold dir-ltr ${tx.type === "expense" ? "text-expense" : "text-income"}`}
                                                    >
                                                        {formatMoney(tx.amount)}
                                                    </span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Settings Modal (MUI Dialog Style) */}
                        {isSettingsOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                                <div
                                    className="absolute inset-0 bg-black/50 backdrop-blur-sm animate-fade-in"
                                    onClick={() => setIsSettingsOpen(false)}
                                ></div>
                                <div className="bg-surface p-6 rounded-[28px] w-full max-w-sm shadow-2xl relative animate-scale-in z-10 max-h-[90vh] overflow-y-auto">
                                    <button
                                        onClick={() => setIsSettingsOpen(false)}
                                        className="absolute top-4 left-4 text-outline hover:text-onPrimaryContainer"
                                    >
                                        <Icon name="close" />
                                    </button>

                                    <h3 className="text-xl font-bold mb-6 text-onPrimaryContainer flex items-center gap-2">
                                        <Icon name="settings" />
                                        تنظیمات
                                    </h3>

                                    {/* Data Management Section */}
                                    <div className="mb-6">
                                        <h4 className="text-sm font-bold text-secondary mb-3">
                                            مدیریت داده‌ها (JSON)
                                        </h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                onClick={handleExportData}
                                                className="flex flex-col items-center justify-center p-4 rounded-xl bg-surfaceVariant hover:bg-primaryContainer hover:text-onPrimaryContainer transition-colors gap-2 text-outline"
                                            >
                                                <Icon
                                                    name="download"
                                                    className="text-2xl"
                                                />
                                                <span className="text-xs font-bold">
                                                    خروجی گرفتن
                                                </span>
                                            </button>
                                            <button
                                                onClick={() =>
                                                    fileInputRef.current.click()
                                                }
                                                className="flex flex-col items-center justify-center p-4 rounded-xl bg-surfaceVariant hover:bg-primaryContainer hover:text-onPrimaryContainer transition-colors gap-2 text-outline"
                                            >
                                                <Icon
                                                    name="upload"
                                                    className="text-2xl"
                                                />
                                                <span className="text-xs font-bold">
                                                    وارد کردن فایل
                                                </span>
                                            </button>
                                        </div>
                                        <p className="text-[10px] text-outline mt-2 text-center opacity-70">
                                            از داده‌های خود فایل پشتیبان (JSON)
                                            تهیه کنید یا فایل قبلی را بارگذاری
                                            نمایید.
                                        </p>
                                    </div>

                                    <hr className="border-surfaceVariant mb-6" />

                                    {/* AI Settings Section */}
                                    <div className="mb-4">
                                        <h4 className="text-sm font-bold text-secondary mb-3">
                                            هوش مصنوعی
                                        </h4>
                                        <div>
                                            <label className="text-xs font-bold text-primary mb-1 block">
                                                OpenRouter API Key
                                            </label>
                                            <input
                                                type="password"
                                                value={openRouterKey}
                                                onChange={(e) =>
                                                    saveKey(e.target.value)
                                                }
                                                placeholder="sk-or-..."
                                                className="w-full bg-surfaceVariant rounded-xl px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary dir-ltr text-left"
                                            />
                                        </div>
                                        <div className="mt-2 text-center">
                                            <a
                                                href="https://openrouter.ai/keys"
                                                target="_blank"
                                                className="text-xs text-ai hover:underline"
                                            >
                                                دریافت کلید رایگان
                                            </a>
                                        </div>
                                    </div>

                                    <button
                                        onClick={() => setIsSettingsOpen(false)}
                                        className="w-full py-3 bg-primary text-onPrimary rounded-xl font-bold shadow-lg shadow-primary/30 mt-2"
                                    >
                                        بستن
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="pt-24 max-w-6xl mx-auto px-4 md:px-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                            {/* Sidebar */}
                            <div className="lg:col-span-4 space-y-6 lg:sticky lg:top-28 h-fit animate-slide-up">
                                {/* Total Balance */}
                                <div className="bg-gradient-to-br from-primaryContainer to-primary rounded-[32px] p-8 text-center text-onPrimaryContainer shadow-xl relative overflow-hidden group border border-white/10">
                                    <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/20 rounded-full blur-2xl group-hover:scale-110 transition-transform duration-700"></div>
                                    <p className="opacity-80 mb-2 text-sm font-medium">
                                        موجودی فعلی
                                    </p>
                                    <h2 className="text-5xl font-black tracking-tight dir-ltr">
                                        {formatMoney(stats.balance)}
                                    </h2>
                                    <p className="text-xs opacity-60 mt-2 font-bold">
                                        تومان
                                    </p>
                                </div>

                                {/* Mini Stats (Clickable for categories?) -> Let's keep simple */}
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-surface p-3 rounded-[24px] border border-surfaceVariant hover:border-income/50 transition-all group card-shadow">
                                        <div className="flex items-center gap-2 text-income mb-1">
                                            <div className="bg-income/10 p-1 rounded-full">
                                                <Icon
                                                    name="arrow_downward"
                                                    className="text-lg"
                                                />
                                            </div>
                                            <span className="text-xs font-bold">
                                                درآمد
                                            </span>
                                        </div>
                                        <p className="font-bold text-lg text-onPrimaryContainer pr-1">
                                            {formatMoney(stats.totalIncome)}
                                        </p>
                                    </div>
                                    <div className="bg-surface p-3 rounded-[24px] border border-surfaceVariant hover:border-expense/50 transition-all group card-shadow">
                                        <div className="flex items-center gap-2 text-expense mb-1">
                                            <div className="bg-expense/10 p-1 rounded-full">
                                                <Icon
                                                    name="arrow_upward"
                                                    className="text-lg"
                                                />
                                            </div>
                                            <span className="text-xs font-bold">
                                                هزینه
                                            </span>
                                        </div>
                                        <p className="font-bold text-lg text-onPrimaryContainer pr-1">
                                            {formatMoney(stats.totalExpense)}
                                        </p>
                                    </div>
                                </div>

                                <button
                                    onClick={handleAdvisor}
                                    disabled={
                                        isAnalyzing || transactions.length === 0
                                    }
                                    className="w-full py-4 bg-aiSurface text-ai border border-ai/20 rounded-[24px] font-bold hover:bg-ai/10 transition-all flex items-center justify-center gap-3 active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm"
                                >
                                    {isAnalyzing ? (
                                        <span className="animate-spin text-xl">
                                            ⏳
                                        </span>
                                    ) : (
                                        <Icon
                                            name="psychology"
                                            className="text-xl"
                                        />
                                    )}
                                    <span>تحلیل وضعیت مالی</span>
                                </button>

                                {aiAnalysis && (
                                    <div className="bg-surface rounded-[24px] p-6 border border-ai/20 animate-scale-in shadow-md relative">
                                        <button
                                            onClick={() => setAiAnalysis(null)}
                                            className="absolute top-4 left-4 text-outline hover:text-error"
                                        >
                                            <Icon name="close" />
                                        </button>
                                        <div className="flex items-center gap-2 text-ai mb-4">
                                            <Icon name="auto_awesome" />
                                            <h3 className="font-bold">
                                                نظریه هوش مصنوعی
                                            </h3>
                                        </div>
                                        <div
                                            className="markdown-body text-sm leading-7 opacity-90"
                                            dangerouslySetInnerHTML={{
                                                __html: marked.parse(
                                                    aiAnalysis,
                                                ),
                                            }}
                                        ></div>
                                    </div>
                                )}
                            </div>

                            {/* Transactions List */}
                            <div
                                className="lg:col-span-8 space-y-4 animate-slide-up"
                                style={{ animationDelay: "0.1s" }}
                            >
                                <div className="flex justify-between items-end px-2">
                                    <h3 className="text-2xl font-bold text-onPrimaryContainer">
                                        تراکنش‌ها
                                    </h3>
                                    <span className="text-xs text-outline font-bold dir-ltr">
                                        {transactions.length} مورد
                                    </span>
                                </div>

                                {transactions.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-20 opacity-40">
                                        <Icon
                                            name="savings"
                                            className="text-8xl mb-4 text-outline"
                                        />
                                        <p className="text-lg font-bold text-outline">
                                            هنوز چیزی ثبت نکردی
                                        </p>
                                    </div>
                                ) : (
                                    <div className="grid gap-3">
                                        {transactions.map((tx, idx) => {
                                            const cat = [
                                                ...categories.expense,
                                                ...categories.income,
                                            ].find(
                                                (c) => c.id === tx.category,
                                            ) || { icon: "help", name: "؟" };
                                            const isExp = tx.type === "expense";
                                            return (
                                                <div
                                                    key={tx.id}
                                                    style={{
                                                        animationDelay: `${idx * 50}ms`,
                                                    }}
                                                    className="bg-surface p-4 rounded-[24px] flex items-center justify-between border border-transparent hover:border-surfaceVariant hover:shadow-lg transition-all animate-slide-up group card-shadow cursor-pointer"
                                                    onClick={() =>
                                                        setSelectedCategoryId(
                                                            tx.category,
                                                        )
                                                    }
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <div
                                                            className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-transform group-hover:scale-110 ${isExp ? "bg-red-50 dark:bg-red-900/30 text-expense" : "bg-green-50 dark:bg-green-900/30 text-income"}`}
                                                        >
                                                            <Icon
                                                                name={cat.icon}
                                                            />
                                                        </div>
                                                        <div>
                                                            <p className="font-bold text-lg text-onPrimaryContainer group-hover:text-primary transition-colors">
                                                                {cat.name}
                                                            </p>
                                                            <p className="text-sm text-outline flex items-center gap-1">
                                                                {tx.desc}{" "}
                                                                <span className="w-1 h-1 rounded-full bg-outline mx-1"></span>{" "}
                                                                {tx.date}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-col items-end gap-2">
                                                        <p
                                                            className={`font-bold text-xl dir-ltr ${isExp ? "text-expense" : "text-income"}`}
                                                        >
                                                            {isExp ? "-" : "+"}
                                                            {formatMoney(
                                                                tx.amount,
                                                            )}
                                                        </p>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                handleDelete(
                                                                    tx.id,
                                                                );
                                                            }}
                                                            className="text-xs text-error opacity-0 group-hover:opacity-100 transition-opacity bg-red-100 dark:bg-red-900 px-2 py-1 rounded-md"
                                                        >
                                                            حذف
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* FAB */}
                        <button
                            onClick={() => {
                                setIsModalOpen(true);
                                setViewStep("input");
                            }}
                            className="fixed bottom-8 left-8 md:bottom-10 md:left-10 w-16 h-16 bg-primary text-onPrimary rounded-[20px] shadow-2xl shadow-primary/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-40 animate-pulse-glow"
                        >
                            <Icon name="add" className="text-4xl" />
                        </button>

                        {/* Add Transaction Modal (MUI Style) */}
                        {isModalOpen && (
                            <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-6">
                                <div
                                    className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-fade-in"
                                    onClick={() => setIsModalOpen(false)}
                                ></div>

                                <div className="bg-surface w-full max-w-lg md:rounded-[32px] rounded-t-[32px] overflow-hidden relative z-10 shadow-2xl animate-slide-up flex flex-col max-h-[90vh]">
                                    {viewStep === "input" && (
                                        <div className="p-8 flex flex-col items-center justify-center min-h-[350px] relative bg-gradient-to-b from-surface to-surfaceVariant/30">
                                            <button
                                                onClick={() =>
                                                    setIsModalOpen(false)
                                                }
                                                className="absolute top-6 left-6 text-outline hover:text-onPrimaryContainer"
                                            >
                                                <Icon name="close" />
                                            </button>

                                            <div className="w-16 h-16 rounded-full bg-aiSurface text-ai flex items-center justify-center mb-6 shadow-lg shadow-ai/10">
                                                <Icon
                                                    name="mic"
                                                    className="text-3xl"
                                                />
                                            </div>

                                            <h3 className="text-2xl font-black text-onPrimaryContainer mb-2">
                                                تراکنش جدید
                                            </h3>
                                            <p className="text-outline mb-8 text-center text-sm">
                                                مثال: «ناهار ۱۸۰ تومن»
                                            </p>

                                            <div className="w-full relative group">
                                                <textarea
                                                    value={aiInput}
                                                    onChange={(e) =>
                                                        setAiInput(
                                                            e.target.value,
                                                        )
                                                    }
                                                    onKeyDown={(e) => {
                                                        if (
                                                            e.key === "Enter" &&
                                                            !e.shiftKey
                                                        ) {
                                                            e.preventDefault();
                                                            handleProcessAI();
                                                        }
                                                    }}
                                                    placeholder="اینجا بنویس..."
                                                    className="w-full bg-surface border-2 border-surfaceVariant text-onPrimaryContainer rounded-[24px] p-5 text-lg shadow-sm focus:border-ai focus:ring-4 focus:ring-ai/10 focus:outline-none transition-all resize-none h-32 leading-relaxed"
                                                    autoFocus
                                                ></textarea>

                                                <button
                                                    onClick={handleProcessAI}
                                                    disabled={
                                                        !aiInput.trim() ||
                                                        isProcessing
                                                    }
                                                    className="absolute bottom-4 left-4 w-12 h-12 bg-ai text-white rounded-xl flex items-center justify-center shadow-lg shadow-ai/30 disabled:opacity-50 hover:scale-105 active:scale-95 transition-all"
                                                >
                                                    {isProcessing ? (
                                                        <span className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span>
                                                    ) : (
                                                        <Icon name="arrow_upward" />
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {viewStep === "review" && (
                                        <div className="flex flex-col h-full bg-surface animate-fade-in overflow-hidden">
                                            <div className="bg-aiSurface p-6 pb-12 relative shrink-0">
                                                <div className="absolute top-0 right-0 p-8 opacity-10">
                                                    <Icon
                                                        name="auto_awesome"
                                                        className="text-9xl"
                                                    />
                                                </div>
                                                <h3 className="text-xl font-bold text-ai relative z-10">
                                                    بررسی هوشمند
                                                </h3>
                                                <p className="text-ai/70 text-sm relative z-10">
                                                    تاریخ امروز:{" "}
                                                    {getTodayShamsi()}
                                                </p>
                                            </div>

                                            <div className="-mt-6 px-6 pb-6 flex-1 overflow-y-auto min-h-0 custom-scrollbar">
                                                <div className="bg-surface rounded-[28px] p-6 shadow-xl space-y-5 border border-surfaceVariant relative">
                                                    <div>
                                                        <label className="text-xs font-bold text-secondary mb-1 block">
                                                            مبلغ (تومان)
                                                        </label>
                                                        <input
                                                            type="number"
                                                            value={
                                                                draftTx.amount
                                                            }
                                                            onChange={(e) =>
                                                                setDraftTx({
                                                                    ...draftTx,
                                                                    amount: e
                                                                        .target
                                                                        .value,
                                                                })
                                                            }
                                                            className="w-full text-3xl font-black bg-transparent border-b-2 border-transparent focus:border-primary focus:outline-none transition-colors dir-ltr text-onPrimaryContainer"
                                                        />
                                                    </div>

                                                    <div className="bg-surfaceVariant p-1.5 rounded-2xl flex">
                                                        <button
                                                            onClick={() =>
                                                                setDraftTx({
                                                                    ...draftTx,
                                                                    type: "expense",
                                                                })
                                                            }
                                                            className={`flex-1 py-3 rounded-xl font-bold transition-all ${draftTx.type === "expense" ? "bg-surface shadow text-expense" : "text-outline"}`}
                                                        >
                                                            هزینه
                                                        </button>
                                                        <button
                                                            onClick={() =>
                                                                setDraftTx({
                                                                    ...draftTx,
                                                                    type: "income",
                                                                })
                                                            }
                                                            className={`flex-1 py-3 rounded-xl font-bold transition-all ${draftTx.type === "income" ? "bg-surface shadow text-income" : "text-outline"}`}
                                                        >
                                                            درآمد
                                                        </button>
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="text-xs font-bold text-secondary mb-1 block">
                                                                تاریخ
                                                            </label>
                                                            <input
                                                                type="text"
                                                                value={
                                                                    draftTx.date
                                                                }
                                                                onChange={(e) =>
                                                                    setDraftTx({
                                                                        ...draftTx,
                                                                        date: e
                                                                            .target
                                                                            .value,
                                                                    })
                                                                }
                                                                className="w-full bg-surfaceVariant rounded-xl px-3 py-3 font-bold text-onPrimaryContainer border-none focus:ring-2 focus:ring-primary/20 dir-ltr text-right"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-secondary mb-1 block">
                                                                توضیحات
                                                            </label>
                                                            <input
                                                                type="text"
                                                                value={
                                                                    draftTx.desc
                                                                }
                                                                onChange={(e) =>
                                                                    setDraftTx({
                                                                        ...draftTx,
                                                                        desc: e
                                                                            .target
                                                                            .value,
                                                                    })
                                                                }
                                                                className="w-full bg-surfaceVariant rounded-xl px-3 py-3 font-bold text-onPrimaryContainer border-none focus:ring-2 focus:ring-primary/20"
                                                            />
                                                        </div>
                                                    </div>

                                                    <div>
                                                        <label className="text-xs font-bold text-secondary mb-2 block">
                                                            دسته‌بندی
                                                        </label>
                                                        <div className="grid grid-cols-4 gap-2">
                                                            {activeCategories.map(
                                                                (cat) => (
                                                                    <button
                                                                        key={
                                                                            cat.id
                                                                        }
                                                                        onClick={() =>
                                                                            setDraftTx(
                                                                                {
                                                                                    ...draftTx,
                                                                                    category:
                                                                                        cat.id,
                                                                                },
                                                                            )
                                                                        }
                                                                        className={`p-2 rounded-xl flex flex-col items-center justify-center transition-all border ${draftTx.category === cat.id ? "bg-primary text-onPrimary border-primary scale-105 shadow-lg shadow-primary/30" : "bg-transparent border-surfaceVariant text-outline hover:bg-surfaceVariant/50"}`}
                                                                    >
                                                                        <Icon
                                                                            name={
                                                                                cat.icon
                                                                            }
                                                                            className="text-xl mb-1"
                                                                        />
                                                                        <span className="text-[10px]">
                                                                            {
                                                                                cat.name
                                                                            }
                                                                        </span>
                                                                    </button>
                                                                ),
                                                            )}
                                                        </div>
                                                    </div>

                                                    <div className="flex gap-3 pt-6 mt-2 border-t border-surfaceVariant/30">
                                                        <button
                                                            onClick={() =>
                                                                setViewStep(
                                                                    "input",
                                                                )
                                                            }
                                                            className="p-4 rounded-2xl text-secondary hover:bg-surfaceVariant transition"
                                                        >
                                                            <Icon name="arrow_forward" />
                                                        </button>
                                                        <button
                                                            onClick={
                                                                handleSaveDraft
                                                            }
                                                            className="flex-1 bg-primary text-onPrimary rounded-2xl font-bold py-4 shadow-xl shadow-primary/30 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2"
                                                        >
                                                            <Icon name="check_circle" />
                                                            تایید و ذخیره
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Custom Alert/Confirm Modal */}
                        <CustomModal
                            isOpen={customModal.isOpen}
                            title={customModal.title}
                            message={customModal.message}
                            type={customModal.type}
                            onConfirm={customModal.onConfirm}
                            onClose={customModal.onClose}
                        />
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
